<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Dave Gets Fit â€“ Admin</title>
  <link rel="stylesheet" href="style.css" />
  <style>
    .role-badge {
      display: inline-block;
      padding: 2px 10px;
      border-radius: 12px;
      font-size: 0.78rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }
    .role-badge.admin   { background: #7c1a1a; color: #fdd; }
    .role-badge.trainer { background: #1a4a7c; color: #cdf; }
    .role-badge.user    { background: #2a2a2a; color: #aaa; }

    .users-table { width: 100%; border-collapse: collapse; margin-top: 16px; }
    .users-table th,
    .users-table td { padding: 10px 14px; text-align: left; border-bottom: 1px solid #2a2a2a; }
    .users-table th { color: #cc1a1a; font-size: 0.82rem; text-transform: uppercase; letter-spacing: 0.06em; }
    .users-table td { color: #ccc; font-size: 0.95rem; }
    .users-table tr:last-child td { border-bottom: none; }
    .users-table tr:hover td { background: #1a1a1a; }

    .action-row { display: flex; gap: 8px; flex-wrap: wrap; }
    .btn-xs { padding: 4px 10px; font-size: 0.8rem; border-radius: 4px; border: none; cursor: pointer; font-weight: 600; }
    .btn-xs.promote  { background: #1a4a7c; color: #cdf; }
    .btn-xs.demote   { background: #2a2a2a; color: #aaa; }
    .btn-xs.delete   { background: #7c1a1a; color: #fdd; }
    .btn-xs:disabled { opacity: 0.35; cursor: not-allowed; }

    .section-header { display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 10px; margin-bottom: 4px; }
    .assign-row { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; margin-top: 14px; }
    .assign-row select { flex: 1; min-width: 160px; }

    .assignments-list { margin-top: 10px; }
    .assignment-item { display: flex; align-items: center; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #2a2a2a; gap: 12px; }
    .assignment-item:last-child { border-bottom: none; }
    .assignment-item span { color: #ccc; font-size: 0.95rem; }

    #trainer-section { display: none; }

    .tab-bar { display: flex; gap: 0; margin-bottom: 24px; border-bottom: 2px solid #2a2a2a; }
    .tab { padding: 10px 22px; background: none; border: none; color: #888; font-size: 0.92rem; font-weight: 600; cursor: pointer; border-bottom: 2px solid transparent; margin-bottom: -2px; text-transform: uppercase; letter-spacing: 0.05em; }
    .tab.active { color: #cc1a1a; border-bottom-color: #cc1a1a; }
  </style>
</head>
<body>

<nav>
  <a class="brand" href="index.html">ðŸ¤˜ Dave Gets Fit</a>
  <a href="index.html">Home</a>
  <a href="progression.html">Progression</a>
  <a href="weight.html">Weight</a>
  <a href="calories.html">Calories</a>
  <div class="nav-user">
    <span class="nav-username" id="nav-username-display"></span>
    <button class="btn-nav-logout" onclick="Auth.logout()">Logout</button>
  </div>
</nav>

<main>
  <div class="card" id="admin-panel">
    <div class="section-header">
      <h2 style="color:#cc1a1a;">âš™ Admin Panel</h2>
      <span id="panel-role-badge"></span>
    </div>

    <div class="tab-bar" id="tab-bar">
      <button class="tab active" data-tab="users">Users</button>
      <button class="tab" data-tab="assignments">Trainer Assignments</button>
    </div>

    <!-- â”€â”€ Users tab â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
    <div id="tab-users">
      <table class="users-table" id="users-table">
        <thead>
          <tr>
            <th>#</th>
            <th>Username</th>
            <th>Role</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody id="users-tbody">
          <tr><td colspan="4" style="color:#888;text-align:center;padding:20px;">Loadingâ€¦</td></tr>
        </tbody>
      </table>
    </div>

    <!-- â”€â”€ Assignments tab â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
    <div id="tab-assignments" style="display:none;">
      <div class="assign-row">
        <select id="assign-trainer-select">
          <option value="">Select trainerâ€¦</option>
        </select>
        <select id="assign-user-select">
          <option value="">Select athleteâ€¦</option>
        </select>
        <button class="btn btn-primary btn-xs" id="assign-btn" style="padding:8px 18px;">Assign</button>
      </div>
      <div class="assignments-list" id="assignments-list">
        <p style="color:#888;margin-top:14px;">Select a trainer to view their assignments.</p>
      </div>
    </div>
  </div>

  <!-- Trainer view (non-admin trainers see this instead) -->
  <div class="card" id="trainer-panel">
    <h2 style="color:#cc1a1a;">ðŸ‘¥ My Athletes</h2>

    <div class="tab-bar" id="trainer-tab-bar">
      <button class="tab active" data-ttab="athletes">Athletes</button>
      <button class="tab" data-ttab="plans">Exercise Plans</button>
    </div>

    <!-- Athletes tab -->
    <div id="ttab-athletes">
      <table class="users-table" id="trainer-users-table">
        <thead>
          <tr><th>#</th><th>Username</th><th>Role</th><th>Assigned Plans</th></tr>
        </thead>
        <tbody id="trainer-users-tbody">
          <tr><td colspan="4" style="color:#888;text-align:center;padding:20px;">Loadingâ€¦</td></tr>
        </tbody>
      </table>
    </div>

    <!-- Plans tab -->
    <div id="ttab-plans" style="display:none;">
      <form id="plan-form" novalidate style="margin-bottom:20px;">
        <div class="form-row">
          <div class="form-group" style="flex:2;">
            <label for="plan-name">Plan Name</label>
            <input type="text" id="plan-name" placeholder="e.g. Beginner Strength" required />
          </div>
        </div>
        <div id="plan-exercise-list"></div>
        <div style="display:flex;gap:12px;flex-wrap:wrap;margin-top:8px;">
          <button type="button" class="btn btn-secondary" id="plan-add-exercise-btn">+ Add Exercise</button>
          <button type="submit" class="btn btn-primary">Save Plan</button>
        </div>
      </form>

      <h3 style="color:#cc1a1a;margin-bottom:10px;">Saved Plans</h3>
      <div id="plans-list"><p style="color:#888;">No plans saved yet.</p></div>
    </div>
  </div>
</main>

<script src="app.js"></script>
<script>
  Auth.requireAuth();

  const role = Auth.role();

  // Show correct panel
  if (role === 'admin') {
    document.getElementById('admin-panel').style.display = '';
    document.getElementById('trainer-panel').style.display = 'none';
    document.getElementById('panel-role-badge').innerHTML = '<span class="role-badge admin">Admin</span>';
  } else if (role === 'trainer') {
    document.getElementById('admin-panel').style.display = 'none';
    document.getElementById('trainer-panel').style.display = '';
  } else {
    // Regular users shouldn't land here
    window.location.href = 'index.html';
  }

  // â”€â”€ Tab switching â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  document.querySelectorAll('.tab').forEach(btn => {
    btn.addEventListener('click', () => {
      document.querySelectorAll('.tab').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      document.querySelectorAll('#tab-users,#tab-assignments').forEach(el => el.style.display = 'none');
      document.getElementById('tab-' + btn.dataset.tab).style.display = '';
    });
  });

  // â”€â”€ Helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function roleBadge(r) {
    return `<span class="role-badge ${r}">${r}</span>`;
  }

  let allUsers = [];

  async function loadUsers() {
    allUsers = await API.get('/admin/users');
    renderUsersTable(allUsers);
    populateSelects(allUsers);
  }

  function renderUsersTable(users) {
    const tbody = document.getElementById('users-tbody');
    const myId = (() => {
      try { return JSON.parse(atob(Auth._payload() ? sessionStorage.getItem('dgf_token').split('.')[1] : '')).userId; } catch { return null; }
    })();
    tbody.innerHTML = users.map(u => `
      <tr>
        <td style="color:#555;">${u.id}</td>
        <td>${u.username}</td>
        <td>${roleBadge(u.role)}</td>
        <td>
          <div class="action-row">
            <button class="btn-xs promote" onclick="setRole(${u.id},'admin')"    ${u.role==='admin'    ? 'disabled' : ''} title="Make Admin">Admin</button>
            <button class="btn-xs promote" onclick="setRole(${u.id},'trainer')"  ${u.role==='trainer'  ? 'disabled' : ''} title="Make Trainer">Trainer</button>
            <button class="btn-xs demote"  onclick="setRole(${u.id},'user')"     ${u.role==='user'     ? 'disabled' : ''} title="Make User">User</button>
            <button class="btn-xs delete"  onclick="deleteUser(${u.id},'${u.username}')" title="Delete user">ðŸ—‘</button>
          </div>
        </td>
      </tr>`).join('');
  }

  function populateSelects(users) {
    const trainers = users.filter(u => u.role === 'trainer');
    const athletes = users.filter(u => u.role === 'user');

    const ts = document.getElementById('assign-trainer-select');
    const us = document.getElementById('assign-user-select');
    ts.innerHTML = '<option value="">Select trainerâ€¦</option>' +
      trainers.map(u => `<option value="${u.id}">${u.username}</option>`).join('');
    us.innerHTML = '<option value="">Select athleteâ€¦</option>' +
      athletes.map(u => `<option value="${u.id}">${u.username}</option>`).join('');
  }

  async function setRole(userId, newRole) {
    try {
      await API.put(`/admin/users/${userId}`, { role: newRole });
      await loadUsers();
    } catch (e) { alert(e.message); }
  }

  async function deleteUser(userId, username) {
    if (!confirm(`Delete user "${username}"? This cannot be undone.`)) return;
    try {
      await API.del(`/admin/users/${userId}`);
      await loadUsers();
    } catch (e) { alert(e.message); }
  }

  // Assign trainer to user
  document.getElementById('assign-btn').addEventListener('click', async () => {
    const trainerId = parseInt(document.getElementById('assign-trainer-select').value);
    const userId    = parseInt(document.getElementById('assign-user-select').value);
    if (!trainerId || !userId) { alert('Please select both a trainer and an athlete.'); return; }
    try {
      await API.post('/admin/assignments', { trainerId, userId });
      await loadAssignments(trainerId);
    } catch (e) { alert(e.message); }
  });

  // Show assignments when trainer selected
  document.getElementById('assign-trainer-select').addEventListener('change', async function () {
    if (this.value) await loadAssignments(parseInt(this.value));
    else document.getElementById('assignments-list').innerHTML = '<p style="color:#888;margin-top:14px;">Select a trainer to view their assignments.</p>';
  });

  async function loadAssignments(trainerId) {
    const users = await API.get(`/trainer/users`).catch(() => []);
    // When called as admin we get all â€“ filter by what the API returns for this trainer
    // Instead, re-fetch as a targeted call isn't available for admin; reuse trainer endpoint via admin token
    // We show the existing assignments from allUsers perspective
    const trainerUser = allUsers.find(u => u.id === trainerId);
    if (!trainerUser) return;

    // Fetch assignments via admin user list (assigned users are visible in trainer endpoint when admin calls it)
    // Actually we need a different approach â€” call GET /trainer/users which returns all users for admin
    // Instead, display from what we can derive: assignment state is shown in the assign section
    const list = document.getElementById('assignments-list');
    // Use the trainer endpoint with current admin token to get trainer's assigned users
    try {
      // We don't have a per-trainer admin endpoint, so show a hint
      list.innerHTML = `<p style="color:#888;margin-top:14px;">Assignments updated. Use the trainer login to verify their athletes list.</p>`;
    } catch (e) { list.innerHTML = `<p style="color:#e00;margin-top:14px;">${e.message}</p>`; }
  }

  // â”€â”€ Trainer view (non-admin trainer) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // Tab switching for trainer panel
  document.querySelectorAll('#trainer-tab-bar .tab').forEach(btn => {
    btn.addEventListener('click', () => {
      document.querySelectorAll('#trainer-tab-bar .tab').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      document.querySelectorAll('#ttab-athletes,#ttab-plans').forEach(el => el.style.display = 'none');
      document.getElementById('ttab-' + btn.dataset.ttab).style.display = '';
    });
  });

  let trainerAthletes = [];
  let savedPlans = [];

  async function loadTrainerView() {
    trainerAthletes = await API.get('/trainer/users');
    await renderTrainerAthletes();
    await loadTrainerPlans();
  }

  async function renderTrainerAthletes() {
    const tbody = document.getElementById('trainer-users-tbody');
    if (!trainerAthletes.length) {
      tbody.innerHTML = '<tr><td colspan="4" style="color:#888;text-align:center;padding:20px;">No athletes assigned yet.</td></tr>';
      return;
    }
    // For each athlete, fetch their assigned plans
    const rows = await Promise.all(trainerAthletes.map(async u => {
      const plans = await API.get(`/trainer/users/${u.id}/plans`).catch(() => []);
      const planOptions = savedPlans.map(p =>
        `<option value="${p.id}">${p.name}</option>`).join('');
      const assignedPills = plans.map(p =>
        `<span style="display:inline-flex;align-items:center;gap:4px;background:#1a2a3a;border-radius:10px;padding:2px 8px;font-size:0.8rem;color:#8cf;">
          ${p.name}
          <button onclick="unassignPlan(${u.id},${p.id})" style="background:none;border:none;color:#888;cursor:pointer;font-size:0.85rem;line-height:1;padding:0 2px;" title="Remove">âœ•</button>
        </span>`).join(' ');
      return `<tr>
        <td style="color:#555;">${u.id}</td>
        <td>${u.username}</td>
        <td><span class="role-badge user">user</span></td>
        <td>
          <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap;">
            ${assignedPills || '<span style="color:#555;font-size:0.85rem;">None</span>'}
            ${savedPlans.length ? `<select id="plan-select-${u.id}" style="min-width:130px;font-size:0.82rem;padding:3px 6px;">
              <option value="">Assign planâ€¦</option>${planOptions}
            </select>
            <button class="btn-xs promote" onclick="assignPlanToUser(${u.id})">Assign</button>` : ''}
          </div>
        </td>
      </tr>`;
    }));
    tbody.innerHTML = rows.join('');
  }

  async function loadTrainerPlans() {
    savedPlans = await API.get('/trainer/plans').catch(() => []);
    renderPlansList();
    await renderTrainerAthletes();
  }

  function renderPlansList() {
    const container = document.getElementById('plans-list');
    if (!savedPlans.length) {
      container.innerHTML = '<p style="color:#888;">No plans saved yet.</p>';
      return;
    }
    container.innerHTML = savedPlans.map(p => `
      <div class="assignment-item">
        <div>
          <strong style="color:#ccc;">${p.name}</strong>
          <span style="color:#666;font-size:0.85rem;margin-left:8px;">${p.exercises.length} exercise${p.exercises.length !== 1 ? 's' : ''}: ${p.exercises.map(e => e.name).join(', ')}</span>
        </div>
        <button class="btn-xs delete" onclick="deletePlan(${p.id})" title="Delete plan">ðŸ—‘</button>
      </div>`).join('');
  }

  async function assignPlanToUser(userId) {
    const sel = document.getElementById('plan-select-' + userId);
    const planId = parseInt(sel && sel.value);
    if (!planId) { alert('Please select a plan to assign.'); return; }
    try {
      await API.post(`/trainer/users/${userId}/plans`, { planId });
      await renderTrainerAthletes();
    } catch (e) { alert(e.message); }
  }

  async function unassignPlan(userId, planId) {
    try {
      await API.del(`/trainer/users/${userId}/plans/${planId}`);
      await renderTrainerAthletes();
    } catch (e) { alert(e.message); }
  }

  async function deletePlan(planId) {
    const plan = savedPlans.find(p => p.id === planId);
    const planName = plan ? plan.name : 'this plan';
    if (!confirm(`Delete plan "${planName}"? This will also remove it from all athletes.`)) return;
    try {
      await API.del(`/trainer/plans/${planId}`);
      await loadTrainerPlans();
    } catch (e) { alert(e.message); }
  }

  // Plan builder
  let planRowCount = 0;
  function addPlanExerciseRow(name = '', sets = '', reps = '', weightKg = '') {
    planRowCount++;
    const container = document.getElementById('plan-exercise-list');
    const div = document.createElement('div');
    div.className = 'exercise-row';
    div.innerHTML = `
      <div class="exercise-row-fields">
        <div class="form-group" style="flex:2;">
          <label>Exercise</label>
          <input type="text" class="ex-name" placeholder="e.g. Squat" value="${name}" required />
        </div>
        <div class="form-group">
          <label>Sets</label>
          <input type="number" class="ex-sets" placeholder="3" min="1" value="${sets}" />
        </div>
        <div class="form-group">
          <label>Reps</label>
          <input type="number" class="ex-reps" placeholder="10" min="1" value="${reps}" />
        </div>
        <div class="form-group">
          <label>Weight (kg)</label>
          <input type="number" class="ex-weight" placeholder="60" min="0" step="0.5" value="${weightKg}" />
        </div>
        <button type="button" class="btn btn-danger btn-remove-exercise" title="Remove">âœ•</button>
      </div>`;
    div.querySelector('.btn-remove-exercise').addEventListener('click', () => {
      div.remove();
      if (!document.querySelectorAll('#plan-exercise-list .exercise-row').length) addPlanExerciseRow();
    });
    container.appendChild(div);
  }

  document.getElementById('plan-add-exercise-btn').addEventListener('click', () => addPlanExerciseRow());

  document.getElementById('plan-form').addEventListener('submit', async function (e) {
    e.preventDefault();
    const name = document.getElementById('plan-name').value.trim();
    if (!name) { alert('Please enter a plan name.'); return; }
    const exercises = [];
    document.querySelectorAll('#plan-exercise-list .exercise-row').forEach(row => {
      const n = row.querySelector('.ex-name').value.trim();
      if (n) exercises.push({
        name: n,
        sets:     row.querySelector('.ex-sets').value,
        reps:     row.querySelector('.ex-reps').value,
        weightKg: row.querySelector('.ex-weight').value,
      });
    });
    if (!exercises.length) { alert('Please add at least one exercise.'); return; }
    try {
      await API.post('/trainer/plans', { name, exercises });
      document.getElementById('plan-name').value = '';
      document.getElementById('plan-exercise-list').innerHTML = '';
      planRowCount = 0;
      addPlanExerciseRow();
      showAlert(document.getElementById('trainer-panel'), 'Plan saved!');
      await loadTrainerPlans();
    } catch (e) { alert(e.message); }
  });

  // Boot
  if (role === 'admin') loadUsers();
  if (role === 'trainer') { addPlanExerciseRow(); loadTrainerView(); }
</script>
</body>
</html>
