<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>GetUs.Fit â€“ Admin</title>
  <link rel="stylesheet" href="style.css" />
  <style>
    .role-badge {
      display: inline-block;
      padding: 2px 10px;
      border-radius: 12px;
      font-size: 0.78rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }
    .role-badge.admin   { background: #7c1a1a; color: #fdd; }
    .role-badge.trainer { background: #1a4a7c; color: #cdf; }
    .role-badge.user    { background: #2a2a2a; color: #aaa; }

    .users-table { width: 100%; border-collapse: collapse; margin-top: 16px; }
    .users-table th,
    .users-table td { padding: 10px 14px; text-align: left; border-bottom: 1px solid #2a2a2a; }
    .users-table th { color: #cc1a1a; font-size: 0.82rem; text-transform: uppercase; letter-spacing: 0.06em; }
    .users-table td { color: #ccc; font-size: 0.95rem; }
    .users-table tr:last-child td { border-bottom: none; }
    .users-table tr:hover td { background: #1a1a1a; }

    .action-row { display: flex; gap: 8px; flex-wrap: wrap; }
    .btn-xs { padding: 4px 10px; font-size: 0.8rem; border-radius: 4px; border: none; cursor: pointer; font-weight: 600; }
    .btn-xs.promote  { background: #1a4a7c; color: #cdf; }
    .btn-xs.demote   { background: #2a2a2a; color: #aaa; }
    .btn-xs.delete   { background: #7c1a1a; color: #fdd; }
    .btn-xs:disabled { opacity: 0.35; cursor: not-allowed; }

    .section-header { display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 10px; margin-bottom: 4px; }
    .assign-row { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; margin-top: 14px; }
    .assign-row select { flex: 1; min-width: 160px; }

    .assignments-list { margin-top: 10px; }
    .assignment-item { display: flex; align-items: center; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #2a2a2a; gap: 12px; }
    .assignment-item:last-child { border-bottom: none; }
    .assignment-item span { color: #ccc; font-size: 0.95rem; }

    #trainer-section { display: none; }

    .tab-bar { display: flex; gap: 0; margin-bottom: 24px; border-bottom: 2px solid #2a2a2a; }
    .tab { padding: 10px 22px; background: none; border: none; color: #888; font-size: 0.92rem; font-weight: 600; cursor: pointer; border-bottom: 2px solid transparent; margin-bottom: -2px; text-transform: uppercase; letter-spacing: 0.05em; }
    .tab.active { color: #cc1a1a; border-bottom-color: #cc1a1a; }
  </style>
</head>
<body>

<nav>
  <a class="brand" href="index.html"><img src="Assets/GetUsTransparent.png" alt="GetUs.Fit" class="brand-logo" /></a>
  <div class="nav-links" id="nav-links">
    <a href="index.html">Home</a>
    <a href="progression.html">Progression</a>
    <a href="weight.html">Weight</a>
    <a href="calories.html">Calories</a>
  </div>
  <div class="nav-user">
    <a class="nav-username" id="nav-username-display" href="profile.html"></a>
    <button class="btn-nav-logout" onclick="Auth.logout()">Logout</button>
  </div>
  <button class="nav-burger" id="nav-burger" aria-label="Toggle menu" aria-expanded="false">&#9776;</button>
</nav>

<main>
  <div class="card" id="admin-panel">
    <div class="section-header">
      <h2 style="color:#cc1a1a;">âš™ Admin Panel</h2>
      <span id="panel-role-badge"></span>
    </div>

    <div class="tab-bar" id="tab-bar">
      <button class="tab active" data-tab="users">Users</button>
      <button class="tab" data-tab="assignments">Trainer Assignments</button>
    </div>

    <!-- â”€â”€ Users tab â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
    <div id="tab-users">
      <div class="section-header" style="margin-top:8px;">
        <span></span>
        <button class="btn btn-primary btn-xs" id="create-user-btn" style="padding:7px 16px;">+ Create User</button>
      </div>

      <!-- Create user inline form (hidden by default) -->
      <div id="create-user-form" style="display:none;background:#1a1a1a;border:1px solid #2a2a2a;border-radius:8px;padding:18px;margin-bottom:16px;">
        <h3 style="margin:0 0 14px;font-size:1rem;color:#cc1a1a;">Create New User</h3>
        <div style="display:flex;gap:10px;flex-wrap:wrap;align-items:flex-end;">
          <div class="form-group" style="margin:0;flex:1;min-width:140px;">
            <label for="new-username" style="font-size:0.82rem;">Username</label>
            <input type="text" id="new-username" placeholder="username" autocomplete="off" />
          </div>
          <div class="form-group" style="margin:0;flex:1;min-width:140px;">
            <label for="new-password" style="font-size:0.82rem;">Password</label>
            <input type="password" id="new-password" placeholder="min 8 chars" autocomplete="new-password" />
          </div>
          <div class="form-group" style="margin:0;min-width:120px;">
            <label for="new-role" style="font-size:0.82rem;">Role</label>
            <select id="new-role">
              <option value="user">user</option>
              <option value="trainer">trainer</option>
              <option value="admin">admin</option>
            </select>
          </div>
          <button class="btn btn-primary btn-xs" id="create-user-submit" style="padding:8px 18px;margin-bottom:1px;">Create</button>
          <button class="btn-xs demote" id="create-user-cancel" style="padding:8px 14px;margin-bottom:1px;">Cancel</button>
        </div>
        <div id="create-user-error" style="color:#e55;font-size:0.85rem;margin-top:10px;"></div>
      </div>

      <table class="users-table" id="users-table">
        <thead>
          <tr>
            <th>#</th>
            <th>Username</th>
            <th>Role</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody id="users-tbody">
          <tr><td colspan="4" style="color:#888;text-align:center;padding:20px;">Loadingâ€¦</td></tr>
        </tbody>
      </table>
    </div>

    <!-- â”€â”€ Assignments tab â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
    <div id="tab-assignments" style="display:none;">
      <div class="assign-row">
        <select id="assign-trainer-select">
          <option value="">Select trainerâ€¦</option>
        </select>
        <select id="assign-user-select">
          <option value="">Select athleteâ€¦</option>
        </select>
        <button class="btn btn-primary btn-xs" id="assign-btn" style="padding:8px 18px;">Assign</button>
      </div>
      <div class="assignments-list" id="assignments-list">
        <p style="color:#888;margin-top:14px;">Select a trainer to view their assignments.</p>
      </div>
    </div>
  </div>

  <!-- Trainer view (non-admin trainers see this instead) -->
  <div class="card" id="trainer-panel">
    <h2 style="color:#cc1a1a;">ðŸ‘¥ My Athletes</h2>
    <table class="users-table" id="trainer-users-table">
      <thead>
        <tr><th>#</th><th>Username</th><th>Role</th></tr>
      </thead>
      <tbody id="trainer-users-tbody">
        <tr><td colspan="3" style="color:#888;text-align:center;padding:20px;">Loadingâ€¦</td></tr>
      </tbody>
    </table>
  </div>
</main>

<script src="app.js"></script>
<script>
  Auth.requireAuth();

  const role = Auth.role();

  // Show correct panel
  if (role === 'admin') {
    document.getElementById('admin-panel').style.display = '';
    document.getElementById('trainer-panel').style.display = 'none';
    document.getElementById('panel-role-badge').innerHTML = '<span class="role-badge admin">Admin</span>';
  } else if (role === 'trainer') {
    document.getElementById('admin-panel').style.display = 'none';
    document.getElementById('trainer-panel').style.display = '';
  } else {
    // Regular users shouldn't land here
    window.location.href = 'index.html';
  }

  // â”€â”€ Tab switching â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  document.querySelectorAll('.tab').forEach(btn => {
    btn.addEventListener('click', () => {
      document.querySelectorAll('.tab').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      document.querySelectorAll('#tab-users,#tab-assignments').forEach(el => el.style.display = 'none');
      document.getElementById('tab-' + btn.dataset.tab).style.display = '';
    });
  });

  // â”€â”€ Helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function roleBadge(r) {
    return `<span class="role-badge ${r}">${r}</span>`;
  }

  let allUsers = [];

  async function loadUsers() {
    allUsers = await API.get('/admin/users');
    renderUsersTable(allUsers);
    populateSelects(allUsers);
  }

  function renderUsersTable(users) {
    const tbody = document.getElementById('users-tbody');
    const myId = (() => {
      try { return JSON.parse(atob(Auth._payload() ? sessionStorage.getItem('dgf_token').split('.')[1] : '')).userId; } catch { return null; }
    })();
    tbody.innerHTML = users.map(u => `
      <tr>
        <td style="color:#555;">${u.id}</td>
        <td>${u.username}</td>
        <td>${roleBadge(u.role)}</td>
        <td>
          <div class="action-row">
            <button class="btn-xs promote" onclick="setRole(${u.id},'admin')"    ${u.role==='admin'    ? 'disabled' : ''} title="Make Admin">Admin</button>
            <button class="btn-xs promote" onclick="setRole(${u.id},'trainer')"  ${u.role==='trainer'  ? 'disabled' : ''} title="Make Trainer">Trainer</button>
            <button class="btn-xs demote"  onclick="setRole(${u.id},'user')"     ${u.role==='user'     ? 'disabled' : ''} title="Make User">User</button>
            <button class="btn-xs delete"  onclick="deleteUser(${u.id},'${u.username}')" title="Delete user">ðŸ—‘</button>
          </div>
        </td>
      </tr>`).join('');
  }

  function populateSelects(users) {
    const trainers = users.filter(u => u.role === 'trainer');
    const athletes = users.filter(u => u.role === 'user');

    const ts = document.getElementById('assign-trainer-select');
    const us = document.getElementById('assign-user-select');
    ts.innerHTML = '<option value="">Select trainerâ€¦</option>' +
      trainers.map(u => `<option value="${u.id}">${u.username}</option>`).join('');
    us.innerHTML = '<option value="">Select athleteâ€¦</option>' +
      athletes.map(u => `<option value="${u.id}">${u.username}</option>`).join('');
  }

  async function setRole(userId, newRole) {
    try {
      await API.put(`/admin/users/${userId}`, { role: newRole });
      await loadUsers();
    } catch (e) { alert(e.message); }
  }

  async function deleteUser(userId, username) {
    if (!confirm(`Delete user "${username}"? This cannot be undone.`)) return;
    try {
      await API.del(`/admin/users/${userId}`);
      await loadUsers();
    } catch (e) { alert(e.message); }
  }

  // â”€â”€ Create user â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  document.getElementById('create-user-btn').addEventListener('click', () => {
    document.getElementById('create-user-form').style.display = '';
    document.getElementById('create-user-btn').style.display = 'none';
    document.getElementById('create-user-error').textContent = '';
    document.getElementById('new-username').value = '';
    document.getElementById('new-password').value = '';
    document.getElementById('new-role').value = 'user';
    document.getElementById('new-username').focus();
  });

  document.getElementById('create-user-cancel').addEventListener('click', () => {
    document.getElementById('create-user-form').style.display = 'none';
    document.getElementById('create-user-btn').style.display = '';
  });

  document.getElementById('create-user-submit').addEventListener('click', async () => {
    const username = document.getElementById('new-username').value.trim();
    const password = document.getElementById('new-password').value;
    const role     = document.getElementById('new-role').value;
    const errEl    = document.getElementById('create-user-error');
    errEl.textContent = '';
    if (!username || !password) { errEl.textContent = 'Username and password are required.'; return; }
    try {
      await API.post('/admin/users', { username, password, role });
      document.getElementById('create-user-form').style.display = 'none';
      document.getElementById('create-user-btn').style.display = '';
      await loadUsers();
    } catch (e) { errEl.textContent = e.message; }
  });
  document.getElementById('assign-btn').addEventListener('click', async () => {
    const trainerId = parseInt(document.getElementById('assign-trainer-select').value);
    const userId    = parseInt(document.getElementById('assign-user-select').value);
    if (!trainerId || !userId) { alert('Please select both a trainer and an athlete.'); return; }
    try {
      await API.post('/admin/assignments', { trainerId, userId });
      await loadAssignments(trainerId);
    } catch (e) { alert(e.message); }
  });

  // Show assignments when trainer selected
  document.getElementById('assign-trainer-select').addEventListener('change', async function () {
    if (this.value) await loadAssignments(parseInt(this.value));
    else document.getElementById('assignments-list').innerHTML = '<p style="color:#888;margin-top:14px;">Select a trainer to view their assignments.</p>';
  });

  async function loadAssignments(trainerId) {
    const users = await API.get(`/trainer/users`).catch(() => []);
    // When called as admin we get all â€“ filter by what the API returns for this trainer
    // Instead, re-fetch as a targeted call isn't available for admin; reuse trainer endpoint via admin token
    // We show the existing assignments from allUsers perspective
    const trainerUser = allUsers.find(u => u.id === trainerId);
    if (!trainerUser) return;

    // Fetch assignments via admin user list (assigned users are visible in trainer endpoint when admin calls it)
    // Actually we need a different approach â€” call GET /trainer/users which returns all users for admin
    // Instead, display from what we can derive: assignment state is shown in the assign section
    const list = document.getElementById('assignments-list');
    // Use the trainer endpoint with current admin token to get trainer's assigned users
    try {
      // We don't have a per-trainer admin endpoint, so show a hint
      list.innerHTML = `<p style="color:#888;margin-top:14px;">Assignments updated. Use the trainer login to verify their athletes list.</p>`;
    } catch (e) { list.innerHTML = `<p style="color:#e00;margin-top:14px;">${e.message}</p>`; }
  }

  // â”€â”€ Trainer view (non-admin trainer) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  async function loadTrainerView() {
    const users = await API.get('/trainer/users');
    const tbody = document.getElementById('trainer-users-tbody');
    if (!users.length) {
      tbody.innerHTML = '<tr><td colspan="3" style="color:#888;text-align:center;padding:20px;">No athletes assigned yet.</td></tr>';
      return;
    }
    tbody.innerHTML = users.map(u => `
      <tr>
        <td style="color:#555;">${u.id}</td>
        <td>${u.username}</td>
        <td><span class="role-badge user">user</span></td>
      </tr>`).join('');
  }

  // Boot
  if (role === 'admin') loadUsers();
  if (role === 'trainer') loadTrainerView();
</script>
</body>
</html>
